# Postman Collection Examples

This document provides examples of how to use the Invest-igator Postman collection.

## Important: tRPC Batch Format

All tRPC endpoints require:
1. Query parameter: `batch=1`
2. Body wrapped in batch format: `{"0": {"json": <your_input>}}`

## Basic Usage Examples

### 1. Authentication Flow

**Step 1: Sign Up**
```json
POST {{baseUrl}}/api/trpc/auth.signup?batch=1

Body:
{
  "0": {
    "json": {
      "email": "testuser@example.com",
      "password": "SecurePass123!",
      "name": "Test User"
    }
  }
}

Expected Response (200):
[
  {
    "result": {
      "data": {
        "json": {
          "ok": true
        }
      }
    }
  }
]
```

**Step 2: Sign In**
```json
POST {{baseUrl}}/api/auth/sign-in/email

Body:
{
  "email": "testuser@example.com",
  "password": "SecurePass123!"
}

Expected Response (200):
Session cookie set automatically
```

**Step 3: Verify Session**
```json
POST {{baseUrl}}/api/trpc/account.getMe?batch=1

Body: (empty or {})

Expected Response (200):
[
  {
    "result": {
      "data": {
        "json": {
          "id": "user_id",
          "email": "testuser@example.com",
          "name": "Test User",
          "avatar": null,
          "emailVerified": false,
          "hasPassword": true
        }
      }
    }
  }
]
```

### 2. Watchlist Management

**Add a Symbol**
```json
POST {{baseUrl}}/api/trpc/watchlist.add?batch=1

Body:
{
  "0": {
    "json": {
      "symbol": "AAPL",
      "displaySymbol": "Apple Inc.",
      "description": "Technology company",
      "type": "Stock"
    }
  }
}

Expected Response (200):
[
  {
    "result": {
      "data": {
        "json": {
          "id": "item_id",
          "userId": "user_id",
          "symbol": "AAPL",
          "displaySymbol": "Apple Inc.",
          "description": "Technology company",
          "type": "Stock",
          "starred": false,
          "createdAt": "2024-11-01T15:16:25.000Z"
        }
      }
    }
  }
]
```

**List Watchlist Items**
```json
POST {{baseUrl}}/api/trpc/watchlist.list?batch=1

Body: (empty or {})

Expected Response (200):
[
  {
    "result": {
      "data": {
        "json": [
          {
            "id": "item_id",
            "symbol": "AAPL",
            "displaySymbol": "Apple Inc.",
            "description": "Technology company",
            "type": "Stock",
            "starred": false,
            "createdAt": "2024-11-01T15:16:25.000Z"
          }
        ]
      }
    }
  }
]
```

**Get Price History**
```json
POST {{baseUrl}}/api/trpc/watchlist.history?batch=1

Body:
{
  "0": {
    "json": {
      "symbols": ["AAPL", "MSFT"],
      "days": 90
    }
  }
}

Expected Response (200):
[
  {
    "result": {
      "data": {
        "json": {
          "AAPL": [
            {
              "date": "2024-08-01",
              "close": 225.50
            }
          ],
          "MSFT": [
            {
              "date": "2024-08-01",
              "close": 425.30
            }
          ]
        }
      }
    }
  }
]
```

### 3. Transaction Management

**Create a Transaction**
```json
POST {{baseUrl}}/api/trpc/transactions.create?batch=1

Body:
{
  "0": {
    "json": {
      "date": "2024-11-01",
      "type": "BUY",
      "symbol": "AAPL",
      "quantity": 10,
      "price": 175.50,
      "currency": "USD",
      "fees": 9.99,
      "notes": "Initial purchase"
    }
  }
}

Expected Response (200):
[
  {
    "result": {
      "data": {
        "json": {
          "id": "transaction_id",
          "userId": "user_id",
          "date": "2024-11-01T00:00:00.000Z",
          "type": "BUY",
          "symbol": "AAPL",
          "quantity": 10,
          "price": 175.50,
          "currency": "USD",
          "fees": 9.99,
          "notes": "Initial purchase",
          "createdAt": "2024-11-01T15:16:25.000Z"
        }
      }
    }
  }
]
```

**List Transactions**
```json
POST {{baseUrl}}/api/trpc/transactions.list?batch=1

Body:
{
  "0": {
    "json": {
      "page": 1,
      "pageSize": 50,
      "symbol": "AAPL",
      "from": "2024-01-01",
      "to": "2024-12-31"
    }
  }
}

Expected Response (200):
[
  {
    "result": {
      "data": {
        "json": {
          "items": [
            {
              "id": "transaction_id",
              "date": "2024-11-01",
              "type": "BUY",
              "symbol": "AAPL",
              "quantity": 10,
              "price": 175.50,
              "currency": "USD",
              "fees": 9.99
            }
          ],
          "total": 1,
  "page": 1,
  "pageSize": 50
}
```

### 4. Portfolio Analytics

**Get Portfolio Structure**
```json
POST {{baseUrl}}/api/trpc/portfolio.structure?batch=1

Body:
{
  "0": {
    "json": {
      "currency": "USD"
    }
  }
}

Expected Response (200):
{
  "holdings": [
    {
      "symbol": "AAPL",
      "quantity": 10,
      "currentPrice": 178.20,
      "value": 1782.00,
      "weight": 0.45,
      "costBasis": 175.50,
      "gainLoss": 27.00,
      "gainLossPercent": 1.54
    }
  ],
  "totalValue": 3960.00,
  "currency": "USD"
}
```

**Calculate Performance**
```json
POST {{baseUrl}}/api/trpc/portfolio.performance?batch=1

Body:
{
  "0": {
    "json": {
      "from": "2024-01-01",
      "to": "2024-11-01",
      "currency": "USD"
    }
  }
}

Expected Response (200):
{
  "points": [
    {
      "date": "2024-01-01",
      "netAssets": 10000.00,
      "yieldTwr": 0,
      "yieldMwr": 0
    },
    // ... daily points
  ],
  "totalReturnTwr": 12.5,
  "totalReturnMwr": 11.8,
  "prevDayReturnTwr": 0.5,
  "prevDayReturnMwr": 0.4
}
```

### 5. API Key Management

**Create API Key**
```json
POST {{baseUrl}}/api/trpc/apiKeys.create?batch=1

Body:
{
  "0": {
    "json": {
      "name": "My Test API Key",
      "expiresAt": "2025-12-31T23:59:59Z",
      "permissions": {
        "watchlist": ["read", "write"],
        "transactions": ["read"]
      },
      "rateLimit": 1000
    }
  }
}

Expected Response (200):
{
  "id": "api_key_id",
  "key": "sk_live_abc123...",  // Only shown once!
  "name": "My Test API Key",
  "expiresAt": "2025-12-31T23:59:59Z",
  "permissions": {...},
  "rateLimit": 1000,
  "createdAt": "2024-11-01T15:16:25.000Z"
}
```

**Use API Key in Requests**
```
Add to request headers:
Authorization: Bearer sk_live_abc123...
```

## Advanced Examples

### CSV Transaction Import
```json
POST {{baseUrl}}/api/trpc/transactions.importCsv?batch=1

Body:
{
  "0": {
    "json": {
      "csvContent": "date,type,symbol,quantity,price,currency,fees,notes\n2024-11-01,BUY,AAPL,10,175.50,USD,9.99,Purchase\n2024-11-02,BUY,MSFT,5,425.30,USD,9.99,Purchase",
      "skipDuplicates": true
    }
  }
}

Expected Response (200):
{
  "imported": 2,
  "skipped": 0,
  "errors": []
}
```

### Admin Operations (Requires Admin Role)

**List Users**
```json
POST {{baseUrl}}/api/trpc/admin.listUsers

Body:
{
  "page": 1,
  "perPage": 50,
  "search": "user@example.com",
  "sortBy": "createdAt",
  "sortDir": "desc"
}

Expected Response (200):
{
  "users": [
    {
      "id": "user_id",
      "email": "user@example.com",
      "name": "User Name",
      "role": "user",
      "createdAt": "2024-11-01T15:16:25.000Z"
    }
  ],
  "total": 1,
  "page": 1,
  "perPage": 50
}
```

**Set User Role**
```json
POST {{baseUrl}}/api/trpc/admin.setRole?batch=1

Body:
{
  "0": {
    "json": {
      "userId": "user_id",
      "role": "admin"
    }
  }
}

Expected Response (200):
{
  "ok": true
}
```

## Error Handling

### Common Error Responses

**401 Unauthorized**
```json
{
  "error": "UNAUTHORIZED",
  "message": "You must be logged in"
}
```

**403 Forbidden**
```json
{
  "error": "FORBIDDEN",
  "message": "Admin access required"
}
```

**400 Bad Request**
```json
{
  "error": "BAD_REQUEST",
  "message": "Invalid input: symbol is required"
}
```

**404 Not Found**
```json
{
  "error": "NOT_FOUND",
  "message": "Resource not found"
}
```

## Testing with Postman Runner

You can use Postman's Collection Runner to test multiple requests in sequence:

1. Click on the collection
2. Click "Run" button
3. Select requests to run
4. Configure data files if needed
5. Click "Run Invest-igator API"

## Newman CLI (Automated Testing)

You can run the collection from command line using Newman:

```bash
# Install Newman
npm install -g newman

# Run the collection
newman run Invest-igator-API.postman_collection.json \
  -e Invest-igator.postman_environment.json \
  --env-var "baseUrl=http://localhost:3000"

# Generate HTML report
newman run Invest-igator-API.postman_collection.json \
  -e Invest-igator.postman_environment.json \
  -r html \
  --reporter-html-export report.html
```

## Tips for Success

1. **Always authenticate first** - Sign in before accessing protected endpoints
2. **Check response codes** - 200 for success, 4xx for client errors, 5xx for server errors
3. **Use variables** - Store common values like user IDs in environment variables
4. **Save responses** - Use "Save Response" to create example responses
5. **Add tests** - Write test scripts to validate responses automatically
6. **Monitor rate limits** - If using API keys, respect rate limits
7. **Handle errors gracefully** - Check error messages for debugging hints

## Next Steps

- Explore the full collection in Postman
- Read the [postman/README.md](./README.md) for detailed documentation
- Check the [OpenAPI schema](http://localhost:3000/api/docs) for comprehensive API reference
- Join the community and contribute improvements
